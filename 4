#!/bin/bash

# Функция для ожидания завершения задачи
wait_for_status() {
    local object_type=$1
    local object_id=$2
    local desired_status=$3
    local current_status

    while true; do
        current_status=$(openstack $object_type show $object_id -f value -c status)
        if [ "$current_status" = "$desired_status" ]; then
            break
        elif [ "$current_status" = "error" ]; then
            echo "Error: $object_type $object_id is in error state"
            return 1
        fi
        sleep 10
    done
}

# Функция для определения каталога бэкапа
get_backup_dir() {
    local volume_id=$1
    case $volume_id in
        volume-a|volume-b) echo "/data/1/" ;;
        volume-c|volume-d) echo "/data/2/" ;;
        volume-e|volume-f) echo "/data/3/" ;;
        *) echo ""; return 1 ;;
    esac
}

# Функция для создания резервной копии одного volume
backup_volume() {
    local volume_id=$1

    # Генерация уникальных имен
    local timestamp=$(date +%Y%m%d%H%M%S)
    local snapshot_name="snapshot_${volume_id}_${timestamp}"
    local clone_volume_name="clone_${volume_id}_${timestamp}"
    local image_name="image_${volume_id}_${timestamp}"
    local backup_name="backup_${volume_id}_${timestamp}.qcow2"

    echo "Starting backup process for volume $volume_id"

    # 1. Создание снимка volume
    openstack volume snapshot create --volume $volume_id --force $snapshot_name
    wait_for_status "volume snapshot" $snapshot_name "available" || return 1

    # 2. Создание клона volume из снимка
    openstack volume create --snapshot $snapshot_name $clone_volume_name
    wait_for_status "volume" $clone_volume_name "available" || return 1

    # 3. Создание образа из клона volume
    openstack image create --volume $clone_volume_name $image_name
    wait_for_status "image" $image_name "active" || return 1

    # Определение каталога для бэкапа
    local backup_dir=$(get_backup_dir "$volume_id")
    if [ -z "$backup_dir" ]; then
        echo "Error: Unable to determine backup directory for volume $volume_id"
        return 1
    fi

    # Создание директории для бэкапов, если она не существует
    mkdir -p "$backup_dir"

    # 4. Сохранение образа в файл
    openstack image save --file "$backup_dir/$backup_name" $image_name

    # Ожидание завершения сохранения файла
    while [ ! -f "$backup_dir/$backup_name" ] || [ "$(lsof "$backup_dir/$backup_name")" ]; do
        sleep 10
    done

    # 5. Удаление образа
    openstack image delete $image_name

    # 6. Удаление клона volume
    openstack volume delete $clone_volume_name

    # 7. Удаление снимка
    openstack volume snapshot delete $snapshot_name

    echo "Backup completed for volume $volume_id: $backup_dir/$backup_name"
}

# Список ID volume для резервного копирования
volume_ids=(
    "volume-a" "volume-b"
    "volume-c" "volume-d"
    "volume-e" "volume-f"
)

# Цикл по всем volume_ids
for volume_id in "${volume_ids[@]}"; do
    if backup_volume "$volume_id"; then
        echo "Backup process successful for volume $volume_id"
    else
        echo "Backup process failed for volume $volume_id"
    fi
done

echo "All backup processes completed"
